# ================================
# RLE Component Makefile
# ================================

SHELL := /bin/bash
COMPONENT_NAME := run_length_encoding
WASM_TARGET := wasm32-wasip2
WASM_OUTPUT := ../../rle_rust.wasm
RUNNER_OUTPUT := ../../rle-runner

.DEFAULT_GOAL := help

# --------------------------------
# 🏗️ Build Targets
# --------------------------------

build:
	@echo "🔨 Building $(COMPONENT_NAME) component..."
	@echo "📦 Checking wasm32-wasip2 target..."
	@if ! rustup target list | grep -q "wasm32-wasip2 (installed)"; then \
		echo "📥 Installing wasm32-wasip2 target..."; \
		rustup target add wasm32-wasip2; \
	fi
	@echo "🧹 Resolving WIT dependencies..."
	@if command -v wit-deps &> /dev/null; then \
		wit-deps || echo "⚠️  wit-deps failed, continuing anyway..."; \
	else \
		echo "⚠️  wit-deps not found, install with: cargo install wit-deps-cli"; \
	fi
	@echo "🚀 Building WASM component..."
	@cargo component build --release --target $(WASM_TARGET) --lib
	@echo "📋 Copying artifact to $(WASM_OUTPUT)..."
	@cp target/$(WASM_TARGET)/release/$(COMPONENT_NAME).wasm $(WASM_OUTPUT)
	@WASM_SIZE=$$(wc -c < "$(WASM_OUTPUT)"); \
	echo "✅ Build complete! $(COMPONENT_NAME).wasm size: $${WASM_SIZE} bytes"

	@if command -v wasm-tools &> /dev/null; then \
		echo "📊 WASM component info:"; \
		wasm-tools component wit $(WASM_OUTPUT) 2>/dev/null | head -20 || echo "  (Component Model format)"; \
	else \
		echo "💡 Install wasm-tools for component analysis: cargo install wasm-tools"; \
	fi
	@echo "🎉 Ready to use: $(WASM_OUTPUT)"


build-runner:
	@echo "🔨 Building rle_rust component and runner..."
	@echo "📦 Checking wasm32-wasip2 target..."
	@if ! rustup target list | grep -q "wasm32-wasip2 (installed)"; then \
		echo "📥 Installing wasm32-wasip2 target..."; \
		rustup target add wasm32-wasip2; \
	fi
	@echo "🧹 Resolving WIT dependencies..."
	@if command -v wit-deps &> /dev/null; then \
		wit-deps || echo "⚠️  wit-deps failed, continuing anyway..."; \
	else \
		echo "⚠️  wit-deps not found, install with: cargo install wit-deps-cli"; \
		exit 1; \
	fi
	@echo "🚀 Building WASM component..."
	@cargo component build --release --target $(WASM_TARGET)
	@echo "📋 Copying component artifact to $(WASM_OUTPUT)..."
	@cp target/$(WASM_TARGET)/release/$(COMPONENT_NAME).wasm $(WASM_OUTPUT)
	@WASM_SIZE=$$(wc -c < "$(WASM_OUTPUT)"); \
	echo "✅ Component build complete! $(COMPONENT_NAME).wasm size: $${WASM_SIZE} bytes"
	@if command -v wasm-tools &> /dev/null; then \
		echo "📊 WASM component info:"; \
		wasm-tools component wit $(WASM_OUTPUT) 2>/dev/null | head -20 || echo "  (Component Model format)"; \
	else \
		echo "💡 Install wasm-tools for component analysis: cargo install wasm-tools"; \
	fi
	@echo "🚀 Building runner binary..."
	@cargo build --release --bin rle-runner
	@echo "📋 Copying runner binary to $(RUNNER_OUTPUT)..."
	@cp target/release/rle-runner $(RUNNER_OUTPUT)
	@RUNNER_SIZE=$$(wc -c < "$(RUNNER_OUTPUT)"); \
	echo "✅ Runner build complete! rle-runner size: $${RUNNER_SIZE} bytes"
	@echo "🎉 Ready to use: $(WASM_OUTPUT) and $(RUNNER_OUTPUT)"
# --------------------------------
# 🧪 Test Targets
# --------------------------------

test:
	@echo "🧪 Running tests for $(COMPONENT_NAME)..."
	@echo "🔨 Building WASM module first (required for integration tests)..."
	@$(MAKE) build
	@echo "🚀 Running wasmtime-based integration tests..."
	@cargo test --test wasm_tests -- --nocapture

test-verbose:
	@echo "🧪 Running verbose tests for $(COMPONENT_NAME)..."
	@echo "🔨 Building WASM module first (required for integration tests)..."
	@$(MAKE) build
	@echo "🚀 Running wasmtime-based integration tests with verbose output..."
	@cargo test --test wasm_tests -- --nocapture --test-threads=1

# --------------------------------
# 🧹 Cleanup Targets
# --------------------------------

clean:
	@echo "🧹 Cleaning $(COMPONENT_NAME) build artifacts..."
	@cargo clean
	@rm -f $(WASM_OUTPUT)
	@echo "✅ Clean complete"

# --------------------------------
# 🔍 Development Targets
# --------------------------------

check:
	@echo "🔍 Checking $(COMPONENT_NAME) code..."
	@cargo check --all-targets --all-features

fmt:
	@echo "🎨 Formatting $(COMPONENT_NAME) code..."
	@cargo fmt --all

lint:
	@echo "🔍 Linting $(COMPONENT_NAME) code..."
	@cargo clippy --all-targets --all-features -- -D warnings

# --------------------------------
# 📊 Info Targets
# --------------------------------

info:
	@echo "📊 $(COMPONENT_NAME) Component Info:"
	@echo "  Language: Rust"
	@echo "  Target: $(WASM_TARGET) (Component Model)"
	@echo "  Output: $(WASM_OUTPUT)"
	@if [ -f "$(WASM_OUTPUT)" ]; then \
		WASM_SIZE=$$(wc -c < "$(WASM_OUTPUT)"); \
		echo "  Size: $${WASM_SIZE} bytes"; \
	else \
		echo "  Status: Not built"; \
	fi

help:
	@echo ""
	@echo "$(COMPONENT_NAME) Component Makefile"
	@echo ""
	@echo "Available targets:"
	@echo "  build         - Build the WASM component"
	@echo "  test          - Run component tests"
	@echo "  test-verbose  - Run tests with verbose output"
	@echo "  clean         - Remove build artifacts"
	@echo "  check         - Check code without building"
	@echo "  fmt           - Format code"
	@echo "  lint          - Run linter checks"
	@echo "  info          - Show component information"
	@echo "  help          - Show this help message"
	@echo ""

.PHONY: build test test-verbose clean check fmt lint info help
